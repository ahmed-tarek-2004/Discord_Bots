<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Full Body Match</title>
    <style>
        body { margin: 0; background: #222; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: sans-serif; overflow: hidden; }
        .container { position: relative; width: 1280px; max-width: 100%; height: 720px; }
        canvas { width: 100%; height: 100%; background: #000; border-radius: 10px; }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; }
        .alert { position: absolute; top: 10px; color: yellow; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 5px; display: none;}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="container">
    <div id="loading_msg" class="loading">جاري التحميل... ارجع للخلف لتظهر منطقة الحزام</div>
    <div id="hip_alert" class="alert"> يرجى الرجوع للخلف لإظهار الخصر (الحزام) للكاميرا</div>
    <video id="input_video" style="display:none"></video>
    <canvas id="output_canvas" width="1280" height="720"></canvas>
</div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const ctx = canvasElement.getContext('2d');
    const loadingMsg = document.getElementById('loading_msg');
    const hipAlert = document.getElementById('hip_alert');

    const productImage = new Image();
    productImage.src = 'my_real_shirt.png'; 
    let isImageLoaded = false;
    productImage.onload = () => { isImageLoaded = true; };

    function onResults(results) {
        loadingMsg.style.display = 'none';

        ctx.save();
        ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        ctx.scale(-1, 1);
        ctx.translate(-canvasElement.width, 0);
        ctx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        ctx.restore();

        if (results.poseLandmarks && isImageLoaded) {
            const leftShoulder = results.poseLandmarks[11];
            const rightShoulder = results.poseLandmarks[12];
            
            const leftHip = results.poseLandmarks[23];
            const rightHip = results.poseLandmarks[24];

            const isUpperBodyVisible = leftShoulder.visibility > 0.5 && rightShoulder.visibility > 0.5;
            const isHipsVisible = leftHip.visibility > 0.5 && rightHip.visibility > 0.5;

            if (isUpperBodyVisible) {
                if (!isHipsVisible) {
                    hipAlert.style.display = 'block'; 
                } else {
                    hipAlert.style.display = 'none';
                    
                    const W = canvasElement.width;
                    const H = canvasElement.height;

                    
                    const lsX = (1 - leftShoulder.x) * W; const lsY = leftShoulder.y * H;
                    const rsX = (1 - rightShoulder.x) * W; const rsY = rightShoulder.y * H;

                    const lhX = (1 - leftHip.x) * W; const lhY = leftHip.y * H;
                    const rhX = (1 - rightHip.x) * W; const rhY = rightHip.y * H;

                   
                    const shoulderCenterX = (lsX + rsX) / 2;
                    const shoulderCenterY = (lsY + rsY) / 2;

                    const hipCenterX = (lhX + rhX) / 2;
                    const hipCenterY = (lhY + rhY) / 2;

                  
                    const shoulderWidth = Math.hypot(lsX - rsX, lsY - rsY);
                    const finalWidth = shoulderWidth * 2.2; 
                    const torsoHeight = Math.hypot(shoulderCenterX - hipCenterX, shoulderCenterY - hipCenterY);
                    const finalHeight = torsoHeight * 1.6; 
                    const angle = Math.atan2(rsY - lsY, rsX - lsX);

                  
                    ctx.save();
                    ctx.translate(shoulderCenterX, shoulderCenterY);
                    ctx.rotate(angle);

                  
                    const neckOffset = finalHeight * 0.20;

                    ctx.drawImage(
                        productImage, 
                        -finalWidth / 2,             
                        -neckOffset,                 
                        finalWidth,                  
                        finalHeight                  
                    );

                    ctx.restore();
                }
            }
        }
    }

    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
    pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    pose.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => { await pose.send({image: videoElement}); },
        width: 1280, height: 720
    });
    camera.start();
</script>

</body>
</html>
